<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½œæ–‡å°è€å¸«ï¼šä¸€å‰‡æ•…äº‹çš„çœæ€</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root { --primary-color: #4285f4; --bg-color: #f0f2f5; }
        body { font-family: sans-serif; background: var(--bg-color); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ç™»å…¥ç•«é¢ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #login-screen input { font-size: 1.2rem; padding: 12px; margin: 10px; border: 2px solid #ddd; border-radius: 12px; width: 200px; text-align: center; }
        #login-screen button { font-size: 1.2rem; padding: 12px 40px; background: var(--primary-color); color: white; border: none; border-radius: 12px; cursor: pointer; }

        /* èŠå¤©å€ */
        header { background: white; padding: 15px; text-align: center; font-weight: bold; color: #444; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        .message { max-width: 85%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; font-size: 1rem; word-wrap: break-word; }
        .bot { align-self: flex-start; background: white; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user { align-self: flex-end; background: var(--primary-color); color: white; border-bottom-right-radius: 4px; }
        
        #input-area { background: white; padding: 15px; display: flex; gap: 10px; border-top: 1px solid #ddd; }
        #user-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 24px; font-size: 1rem; outline: none; }
        #send-btn { background: var(--primary-color); color: white; border: none; padding: 0 20px; border-radius: 24px; font-weight: bold; cursor: pointer; }
        #send-btn:disabled { background: #ccc; }
        
        .typing-indicator { display: none; align-self: flex-start; background: transparent; color: #888; font-size: 0.9rem; margin-left: 10px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>ğŸ‘‹ ä½œæ–‡å°å¹«æ‰‹</h2>
        <p>è«‹è¼¸å…¥åº§è™Ÿé–‹å§‹</p>
        <input type="text" id="student-id" placeholder="ä¾‹å¦‚: 01" inputmode="numeric">
        <button onclick="startSession()">é–‹å§‹</button>
    </div>

    <header id="header-title">ä¸€å‰‡æ•…äº‹çš„çœæ€</header>
    <div id="chat-container"></div>
    <div class="typing-indicator" id="loader">è€å¸«æ­£åœ¨è¼¸å…¥...</div>
    
    <div id="input-area">
        <input type="text" id="user-input" placeholder="è¼¸å…¥ä½ çš„æƒ³æ³•..." onkeypress="handleKeyPress(event)">
        <button id="send-btn" onclick="sendMessage()">é€å‡º</button>
    </div>

<script>
    // ==========================================================
    //  è®Šæ•¸è¨­å®šå€
    // ==========================================================

    // 1. ç³»çµ±æç¤ºè© (System Prompt) - æ”¾åœ¨æœ€ä¸Šé¢ç¢ºä¿å…ˆè¢«è®€å–
    const SYSTEM_PROMPT = `
    ä½ æ˜¯ä¸€ä½åœ‹å°å…­å¹´ç´šåœ‹èªè€å¸«ã€‚ä»»å‹™æ˜¯å¼•å°å­¸ç”Ÿå®Œæˆä½œæ–‡ã€ˆä¸€å‰‡æ•…äº‹çš„çœæ€ã€‰ã€‚
    
    ã€è¦å‰‡ã€‘
    1. ä¸å¯ä»¥ç›´æ¥å¹«å­¸ç”Ÿå¯«ä½œæ–‡ã€‚
    2. è¦ä¸€æ­¥ä¸€æ­¥å•å•é¡Œã€‚
    3. èªæ°£è¦è¦ªåˆ‡é¼“å‹µã€‚

    ã€æ•™å­¸æ­¥é©Ÿã€‘
    1. å•å­¸ç”Ÿæƒ³å¯«å“ªä¸€å‰‡æ•…äº‹ï¼Ÿ(è‹¥æ²’æƒ³æ³•å¯æä¾›ï¼šé¾œå…”è³½è·‘ã€äº•åº•ä¹‹è›™ã€æ”¾ç¾Šçš„å­©å­)ã€‚
    2. è«‹å­¸ç”Ÿç°¡å–®èªªèªªæ•…äº‹å…§å®¹ã€‚
    3. å•å­¸ç”Ÿé€™å€‹æ•…äº‹å­¸åˆ°äº†ä»€éº¼é“ç†ï¼Ÿ
    4. å•å­¸ç”Ÿç”Ÿæ´»ä¸­æœ‰æ²’æœ‰é¡ä¼¼çš„ç¶“é©—æˆ–æ‡‰ç”¨ï¼Ÿ
    5. æœ€å¾Œå¹«å­¸ç”Ÿæ•´ç†å‡ºå¯«ä½œå¤§ç¶±ã€‚

    è«‹å…ˆå‘å­¸ç”Ÿæ‰“æ‹›å‘¼ä¸¦é–‹å§‹ç¬¬ä¸€æ­¥ã€‚
    `;

    // 2. Google Gemini API Key (è«‹å‹™å¿…æ›æˆæ–°çš„ï¼)
    // å»é€™è£¡ç”³è«‹: https://aistudio.google.com/app/apikey
    const GEMINI_API_KEY = "AIzaSyClkYyp3mkAQaYM7kVzX_GoJ_-2Z3e4ZM4"; 

    // 3. Firebase Config (ä¿ç•™æ‚¨åŸæœ¬æ­£ç¢ºçš„è¨­å®š)
    const firebaseConfig = {
        apiKey: "AIzaSyDaYe4bu-RujGIfzjzKkrZgl1EPCxGYVN4",
        authDomain: "writing-ai-teacher.firebaseapp.com",
        projectId: "writing-ai-teacher",
        storageBucket: "writing-ai-teacher.firebasestorage.app",
        messagingSenderId: "108006740134",
        appId: "1:108006740134:web:a203bd35d14f345aa56467",
        measurementId: "G-TBVCG59B3M"
    };

    // ==========================================================
    //  ä¸»ç¨‹å¼é‚è¼¯
    // ==========================================================

    // åˆå§‹åŒ– Firebase
    try {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase åˆå§‹åŒ–æˆåŠŸ");
    } catch (e) {
        console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
    }
    const db = firebase.firestore();

    let studentId = "";
    let chatHistory = []; 

    function startSession() {
        const input = document.getElementById('student-id').value.trim();
        if (!input) return alert("è«‹è¼¸å…¥åº§è™Ÿï¼");
        
        studentId = input;
        document.getElementById('header-title').innerText = `ä¸€å‰‡æ•…äº‹çš„çœæ€ (åº§è™Ÿ: ${studentId})`;
        document.getElementById('login-screen').style.display = 'none';

        // åˆå§‹åŒ–å°è©±ç´€éŒ„
        chatHistory = [
            { role: "user", parts: [{ text: SYSTEM_PROMPT }] },
            { role: "model", parts: [{ text: "æ”¶åˆ°ï¼Œæˆ‘æœƒæ‰®æ¼”å¥½è€å¸«çš„è§’è‰²ã€‚" }] }
        ];

        // é¡¯ç¤ºé–‹å ´ç™½ (ä¸æ¶ˆè€— Token)
        const welcomeMsg = `å“ˆå›‰ï¼æˆ‘æ˜¯ä½œæ–‡è€å¸«ã€‚åº§è™Ÿ ${studentId} çš„åŒå­¸ä½ å¥½ï¼\n\næˆ‘å€‘ä»Šå¤©è¦ç·´ç¿’å¯«ã€ˆä¸€å‰‡æ•…äº‹çš„çœæ€ã€‰ã€‚\n\n**é¦–å…ˆï¼Œä½ æƒ³å¥½è¦å¯«å“ªä¸€å€‹æ•…äº‹äº†å—ï¼Ÿ**\n(ä¾‹å¦‚ï¼šé¾œå…”è³½è·‘ã€æ”¾ç¾Šçš„å­©å­ï¼Œæˆ–æ˜¯ä½ è‡ªå·±çœ‹éçš„æ›¸éƒ½å¯ä»¥å–”ï¼)`;
        appendMessage("bot", welcomeMsg);
        chatHistory.push({ role: "model", parts: [{ text: welcomeMsg }] });
    }

    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const userText = inputField.value.trim();
        if (!userText) return;

        // 1. é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
        appendMessage("user", userText);
        inputField.value = "";
        saveToFirebase(userText, "user");

        // 2. å‘¼å« Gemini
        chatHistory.push({ role: "user", parts: [{ text: userText }] });
        document.getElementById('loader').style.display = 'block';
        document.getElementById('send-btn').disabled = true;

        try {
            const botReply = await callGeminiAPI(chatHistory);
            
            appendMessage("bot", botReply);
            chatHistory.push({ role: "model", parts: [{ text: botReply }] });
            saveToFirebase(botReply, "model");

        } catch (error) {
            console.error("Gemini éŒ¯èª¤:", error);
            // é¡¯ç¤ºæ›´è©³ç´°çš„éŒ¯èª¤çµ¦ä½¿ç”¨è€…
            appendMessage("bot", `âš ï¸ è€å¸«é€£ç·šå¤±æ•—äº†ã€‚\néŒ¯èª¤åŸå› : ${error.message}\nè«‹ç¢ºèª API Key æ˜¯å¦æ­£ç¢ºã€‚`);
        } finally {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('send-btn').disabled = false;
            inputField.focus();
        }
    }

    async function callGeminiAPI(history) {
        // ä½¿ç”¨ gemini-1.5-flash æ¨¡å‹
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        const payload = {
            contents: history
        };

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        
        // æª¢æŸ¥æ˜¯å¦å›å‚³éŒ¯èª¤
        if (!response.ok) {
            let errMsg = data.error ? data.error.message : response.statusText;
            throw new Error(`Google API Error (${response.status}): ${errMsg}`);
        }
        
        return data.candidates[0].content.parts[0].text;
    }

    function appendMessage(sender, text) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        // ä½¿ç”¨ marked è§£æï¼Œè‹¥å¤±æ•—å‰‡é¡¯ç¤ºç´”æ–‡å­—
        try {
            div.innerHTML = marked.parse(text);
        } catch (e) {
            div.textContent = text;
        }
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function saveToFirebase(text, role) {
        if (!db) return;
        const docRef = db.collection("grade6_essays").doc(studentId);
        
        docRef.collection("chat").add({
            text: text,
            role: role,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        docRef.set({
            student_id: studentId,
            last_active: firebase.firestore.FieldValue.serverTimestamp(),
            last_message: text.substring(0, 20) + "..."
        }, { merge: true });
    }

    function handleKeyPress(e) {
        if (e.key === 'Enter') sendMessage();
    }
</script>
</body>
</html>
