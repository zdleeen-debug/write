<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½œæ–‡å°è€å¸«ï¼šä¸€å‰‡æ•…äº‹çš„çœæ€</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* ç°¡å–®æ¸…çˆ½çš„ä»‹é¢é¢¨æ ¼ï¼Œé©åˆå¹³æ¿æ“ä½œ */
        :root { --primary-color: #4285f4; --bg-color: #f0f2f5; --chat-bg: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ç™»å…¥ç•«é¢ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        #login-screen h2 { color: #333; margin-bottom: 10px; }
        #login-screen p { color: #666; margin-bottom: 20px; }
        #login-screen input { font-size: 1.2rem; padding: 12px; margin: 10px; border: 2px solid #ddd; border-radius: 12px; width: 200px; text-align: center; outline: none; transition: 0.3s; }
        #login-screen input:focus { border-color: var(--primary-color); }
        #login-screen button { font-size: 1.2rem; padding: 12px 40px; background: var(--primary-color); color: white; border: none; border-radius: 12px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(66,133,244,0.2); }
        #login-screen button:hover { background: #3367d6; transform: translateY(-2px); }

        /* é ‚éƒ¨æ¨™é¡Œåˆ— */
        header { background: white; padding: 15px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-weight: bold; color: #444; font-size: 1.1rem; z-index: 10; }
        
        /* èŠå¤©å€åŸŸ */
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; background: var(--bg-color); }
        
        /* è¨Šæ¯æ³¡æ³¡æ¨£å¼ */
        .message { max-width: 85%; padding: 12px 18px; border-radius: 18px; line-height: 1.6; font-size: 1rem; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .bot { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 4px; }
        .user { align-self: flex-end; background: var(--primary-color); color: white; border-bottom-right-radius: 4px; }
        .message p { margin: 0 0 10px 0; }
        .message p:last-child { margin: 0; }
        .message ul, .message ol { padding-left: 20px; margin: 5px 0; }

        /* åº•éƒ¨è¼¸å…¥å€ */
        #input-area { background: white; padding: 15px; display: flex; gap: 10px; border-top: 1px solid #ddd; align-items: center; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        #user-input { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 1rem; outline: none; background: #f8f9fa; transition: 0.3s; }
        #user-input:focus { border-color: var(--primary-color); background: white; }
        #send-btn { background: var(--primary-color); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; }
        #send-btn:hover { background: #3367d6; }
        #send-btn:disabled { background: #ccc; cursor: not-allowed; }
        #send-btn svg { width: 20px; height: 20px; fill: white; }

        /* è¼‰å…¥å‹•ç•« */
        .typing-indicator { display: none; align-self: flex-start; background: transparent; padding: 0 10px; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .dots { display: inline-block; animation: dot-blink 1.5s infinite linear; }
        @keyframes dot-blink { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>âœï¸ ä½œæ–‡å°å¹«æ‰‹</h2>
        <p>åº·è»’åœ‹èªå…­ä¸Šï¼šä¸€å‰‡æ•…äº‹çš„çœæ€</p>
        <input type="text" id="student-id" placeholder="è«‹è¼¸å…¥åº§è™Ÿ (ä¾‹å¦‚: 05)" inputmode="numeric">
        <button onclick="startSession()">é–‹å§‹å¯«ä½œ</button>
    </div>

    <header id="header-title">ä¸€å‰‡æ•…äº‹çš„çœæ€</header>
    
    <div id="chat-container">
        </div>
    <div class="typing-indicator" id="loader">è€å¸«æ­£åœ¨æ€è€ƒ<span class="dots">...</span></div>
    
    <div id="input-area">
        <input type="text" id="user-input" placeholder="è¼¸å…¥ä½ çš„æƒ³æ³•..." onkeypress="handleKeyPress(event)" autocomplete="off">
        <button id="send-btn" onclick="sendMessage()">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
        </button>
    </div>

<script>
    // ==========================================================
    //  è¨­å®šå€ï¼šå·²æ•´åˆæ‚¨çš„ Key å’Œ Config
    // ==========================================================
    
    // 1. Gemini API Key (ä¾†è‡ªæ‚¨çš„ä¸Šä¸€å‰‡è¨Šæ¯)
    const GEMINI_API_KEY = "AIzaSyAxGBHI8oM_87F-cgR1pA0ESOmFosH1sN4"; 

    // 2. Firebase Config (ä¾†è‡ªæ‚¨å‰›å‰›æä¾›çš„ writing-ai-teacher å°ˆæ¡ˆ)
    const firebaseConfig = {
        apiKey: "AIzaSyDaYe4bu-RujGIfzjzKkrZgl1EPCxGYVN4",
        authDomain: "writing-ai-teacher.firebaseapp.com",
        projectId: "writing-ai-teacher",
        storageBucket: "writing-ai-teacher.firebasestorage.app",
        messagingSenderId: "108006740134",
        appId: "1:108006740134:web:a203bd35d14f345aa56467",
        measurementId: "G-TBVCG59B3M"
    };

    // ==========================================================
    //  ç³»çµ±é‚è¼¯é–‹å§‹
    // ==========================================================

    // åˆå§‹åŒ– Firebase
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {
        console.error("Firebase åˆå§‹åŒ–éŒ¯èª¤:", e);
        alert("ç³»çµ±é€£ç·šè¨­å®šæœ‰èª¤ï¼Œè«‹é€šçŸ¥è€å¸«ï¼");
    }
    const db = firebase.firestore();

    let studentId = "";
    let chatHistory = []; 

    [cite_start]// ç³»çµ±æç¤ºè©ï¼šæ ¹æ“šæ‚¨æä¾›çš„ PDF å¯«ä½œæŒ‡å°è¨­è¨ˆ [cite: 3-24]
    const SYSTEM_PROMPT = `
    ä½ æ˜¯ä¸€ä½è¦ªåˆ‡ã€æœ‰è€å¿ƒçš„åœ‹å°å…­å¹´ç´šåœ‹èªè€å¸«ã€‚ä½ çš„ä»»å‹™æ˜¯é€éå°è©±ï¼Œå¼•å°å­¸ç”Ÿå®Œæˆåº·è»’ç‰ˆå…­ä¸Šç¬¬ä¹èª²çš„ä½œæ–‡ã€ˆä¸€å‰‡æ•…äº‹çš„çœæ€ã€‰ã€‚
    
    ã€é‡è¦åŸå‰‡ã€‘
    1. **ç¦æ­¢ä»£å¯«**ï¼šä¸å¯ä»¥å¹«å­¸ç”Ÿå¯«å‡ºæ•´æ®µæ–‡ç« ï¼Œä½ è¦åšçš„æ˜¯ã€Œæå•ã€å’Œã€Œå¼•å°ã€ã€‚
    2. **æ­£å‘é¼“å‹µ**ï¼šå¤šç”¨ã€Œå¾ˆæ£’çš„æƒ³æ³•ï¼ã€ã€ã€Œé€™å€‹è§€é»å¾ˆæœ‰è¶£ã€ä¾†å»ºç«‹å­¸ç”Ÿä¿¡å¿ƒã€‚
    3. **åˆ†æ­¥é©Ÿé€²è¡Œ**ï¼šä¸€æ¬¡åªå•ä¸€å€‹å•é¡Œï¼Œä¸è¦ä¸€æ¬¡ä¸Ÿå‡ºä¸€å †å•é¡Œã€‚

    ã€æ•™å­¸æµç¨‹ã€‘è«‹ä¾ç…§ä»¥ä¸‹é †åºå¼•å°ï¼š
    1. [cite_start]**é¸å®šæ•…äº‹**ï¼šè©¢å•å­¸ç”Ÿæƒ³å¯«å“ªä¸€å‰‡æ•…äº‹ï¼Ÿ(è‹¥å­¸ç”Ÿå¡ä½ï¼Œè«‹æä¾›é¸é …å¦‚ï¼šé¾œå…”è³½è·‘ã€æ”¾ç¾Šçš„å­©å­ã€äº•åº•ä¹‹è›™ã€ä¸‰äººæˆè™ç­‰) [cite: 5-6]ã€‚
    2. [cite_start]**ç°¡è¿°å…§å®¹**ï¼šè«‹å­¸ç”Ÿç”¨è‡ªå·±çš„è©±ï¼Œç°¡å–®èªªä¸€ä¸‹æ•…äº‹åœ¨è¬›ä»€éº¼(ä¸»è§’ã€ç™¼ç”Ÿä»€éº¼äº‹) [cite: 9]ã€‚
    3. [cite_start]**ç¢ºç«‹ä¸»æ—¨**ï¼šå•å­¸ç”Ÿé€™å‰‡æ•…äº‹æ•™æœƒæˆ‘å€‘ä»€éº¼é“ç†ï¼Ÿ [cite: 8, 12]ã€‚
    4. [cite_start]**è‡ªæˆ‘çœæ€èˆ‡æ‡‰ç”¨**ï¼šå¼•å°å­¸ç”Ÿæ€è€ƒï¼Œé€™å€‹é“ç†å¦‚ä½•é‹ç”¨åœ¨ç”Ÿæ´»ä¸­ï¼Ÿè‡ªå·±æœ‰æ²’æœ‰é¡ä¼¼çš„ç¶“é©—ï¼Ÿæˆ–æ˜¯æœªä¾†æœƒæ€éº¼åšï¼Ÿ [cite: 13-15]ã€‚
    5. [cite_start]**ç¸½çµèˆ‡å¤§ç¶±**ï¼šç•¶ä¸Šè¿°æ­¥é©Ÿéƒ½å®Œæˆå¾Œï¼Œå¹«å­¸ç”Ÿæ•´ç†å‡ºä¸€ä»½ã€Œå¯«ä½œæ¶æ§‹è¡¨ã€(åŒ…å«ç·£èµ·ã€æ•…äº‹å…§å®¹ã€çœæ€ã€çµèª)ï¼Œä¸¦é¼“å‹µä»–å°‡å…§å®¹å¯«åœ¨ç¨¿ç´™ä¸Š [cite: 17-24]ã€‚

    ç¾åœ¨ï¼Œè«‹å…ˆå‘å­¸ç”Ÿæ‰“æ‹›å‘¼ï¼Œç¢ºèªä»–çš„åº§è™Ÿï¼Œä¸¦é–‹å§‹ç¬¬ä¸€æ­¥ã€‚
    `;

    // å•Ÿå‹•å°è©±
    function startSession() {
        const input = document.getElementById('student-id').value.trim();
        if (!input) return alert("è«‹è¼¸å…¥åº§è™Ÿæ‰èƒ½é–‹å§‹å–”ï¼");
        
        studentId = input;
        document.getElementById('header-title').innerText = `ä¸€å‰‡æ•…äº‹çš„çœæ€ (åº§è™Ÿ: ${studentId})`;
        document.getElementById('login-screen').style.display = 'none';

        // è¨­å®šåˆå§‹æ­·å²ç´€éŒ„ (éš±è—çš„ç³»çµ±æŒ‡ä»¤)
        chatHistory = [
            { role: "user", parts: [{ text: SYSTEM_PROMPT }] },
            { role: "model", parts: [{ text: "æ”¶åˆ°ï¼Œæˆ‘æ˜¯ä½œæ–‡è€å¸«ï¼Œæˆ‘æœƒä¾ç…§æ­¥é©Ÿå¼•å°å­¸ç”Ÿã€‚" }] }
        ];

        // æ©Ÿå™¨äººé–‹å ´ç™½
        const openingText = `å“ˆå›‰ï¼æˆ‘æ˜¯ä½ çš„ä½œæ–‡å°å¹«æ‰‹ã€‚ğŸ‘‹\nåº§è™Ÿ **${studentId}** çš„åŒå­¸ä½ å¥½ï¼\n\næˆ‘å€‘ä»Šå¤©è¦ä¾†ç·´ç¿’å¯«ã€ˆä¸€å‰‡æ•…äº‹çš„çœæ€ã€‰ã€‚å¯«ä½œçš„ç¬¬ä¸€æ­¥æ˜¯é¸æ•…äº‹ã€‚\n\n**ä½ æƒ³å¥½è¦å¯«å“ªä¸€å€‹æ•…äº‹äº†å—ï¼Ÿ**\n(ä¾‹å¦‚ï¼šç«¥è©±æ•…äº‹ã€å¯“è¨€ï¼Œæˆ–æ˜¯ä½ æœ€è¿‘çœ‹éçš„æ›¸éƒ½å¯ä»¥å–”ï¼å¦‚æœæ²’æƒ³æ³•ä¹Ÿå¯ä»¥å‘Šè¨´æˆ‘ã€‚)`;
        
        appendMessage("bot", openingText);
        
        // è¨˜éŒ„é–‹å ´ç™½åˆ°æ­·å²ï¼Œä½†ä¸é€å‡º API (ç¯€çœé¡åº¦)
        chatHistory.push({ role: "model", parts: [{ text: openingText }] });
    }

    // ç™¼é€è¨Šæ¯è™•ç†
    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const userText = inputField.value.trim();
        if (!userText) return;

        // 1. é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
        appendMessage("user", userText);
        inputField.value = "";
        
        // 2. å„²å­˜åˆ° Firebase (å³æ™‚å‚™ä»½)
        saveToFirebase(userText, "user");

        // 3. æº–å‚™å‘¼å« Gemini
        chatHistory.push({ role: "user", parts: [{ text: userText }] });
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        document.getElementById('loader').style.display = 'block';
        document.getElementById('send-btn').disabled = true;

        try {
            // å‘¼å« API
            const botReply = await callGeminiAPI(chatHistory);
            
            // 4. é¡¯ç¤ºæ©Ÿå™¨äººå›æ‡‰
            appendMessage("bot", botReply);
            chatHistory.push({ role: "model", parts: [{ text: botReply }] });
            saveToFirebase(botReply, "model");

        } catch (error) {
            console.error("Gemini Error:", error);
            appendMessage("bot", "è€å¸«ç¾åœ¨ç¶²è·¯æœ‰é»å¡å¡çš„ï¼Œè«‹å†å‚³é€ä¸€æ¬¡è©¦è©¦çœ‹ï¼ğŸ˜…");
        } finally {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('send-btn').disabled = false;
            // ä¿æŒç„¦é»åœ¨è¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿é€£çºŒæ‰“å­—
            inputField.focus();
        }
    }

    // å‘¼å« Google Gemini API
    async function callGeminiAPI(history) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        const payload = {
            contents: history,
            generationConfig: {
                maxOutputTokens: 800,
                temperature: 0.7 
            }
        };

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error.message);
        }
        return data.candidates[0].content.parts[0].text;
    }

    // å°‡è¨Šæ¯é¡¯ç¤ºåœ¨èŠå¤©è¦–çª—
    function appendMessage(sender, text) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        // ä½¿ç”¨ marked è§£æ Markdown æ ¼å¼ (è®“åˆ—è¡¨ã€ç²—é«”èƒ½æ­£å¸¸é¡¯ç¤º)
        div.innerHTML = marked.parse(text); 
        container.appendChild(div);
        
        // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
        container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
    }

    // å„²å­˜è³‡æ–™åˆ° Firestore
    function saveToFirebase(text, role) {
        if (!db) return;
        
        const docRef = db.collection("grade6_essays").doc(studentId);
        
        // 1. æ–°å¢å°è©±ç´€éŒ„åˆ°å­é›†åˆ
        docRef.collection("chat").add({
            text: text,
            role: role,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // 2. æ›´æ–°å­¸ç”Ÿçš„æœ€å¾Œç‹€æ…‹ (æ–¹ä¾¿è€å¸«åœ¨å¾Œå°åˆ—è¡¨æŸ¥çœ‹)
        docRef.set({
            student_id: studentId,
            last_active: firebase.firestore.FieldValue.serverTimestamp(),
            last_message: text.substring(0, 30) + (text.length > 30 ? "..." : ""),
            status: "é€²è¡Œä¸­" 
        }, { merge: true });
    }

    // æŒ‰ä¸‹ Enter éµç™¼é€
    function handleKeyPress(e) {
        if (e.key === 'Enter') sendMessage();
    }
</script>
</body>
</html>
