<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½œæ–‡å°å¹«æ‰‹</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root { --primary-color: #4285f4; --bg-color: #f0f2f5; --warn-color: #fbbc04; --error-color: #ea4335; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ç™»å…¥ç•«é¢ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        #login-screen input { font-size: 1.2rem; padding: 12px; margin: 10px; border: 2px solid #ddd; border-radius: 12px; width: 200px; text-align: center; outline: none; }
        #login-screen button { font-size: 1.2rem; padding: 12px 40px; background: var(--primary-color); color: white; border: none; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        
        /* èŠå¤©ä»‹é¢ */
        header { background: white; padding: 15px; text-align: center; font-weight: bold; color: #444; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 10; font-size: 1.1rem; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; background: #f0f2f5; }
        
        .message { max-width: 85%; padding: 12px 18px; border-radius: 18px; line-height: 1.6; font-size: 1rem; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .bot { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 4px; }
        .user { align-self: flex-end; background: var(--primary-color); color: white; border-bottom-right-radius: 4px; }
        
        /* å¿«é€ŸæŒ‰éˆ•å€ */
        #quick-actions { background: #fff; padding: 10px; display: flex; gap: 10px; overflow-x: auto; border-top: 1px solid #eee; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .quick-btn { padding: 8px 15px; background: #e8f0fe; color: #1967d2; border: 1px solid #d2e3fc; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: 0.2s; font-weight: 500; }
        
        /* è¼¸å…¥å€åŸŸ */
        #input-area { background: white; padding: 10px 15px 20px 15px; display: flex; gap: 10px; border-top: 1px solid #f0f0f0; }
        #user-input { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 1rem; outline: none; background: #f8f9fa; }
        
        /* ç™¼é€æŒ‰éˆ•ç‹€æ…‹ (ç´…ç¶ ç‡ˆ) */
        #send-btn { background: var(--primary-color); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        #send-btn:disabled { background: #ccc; cursor: not-allowed; }
        #send-btn.cooling { background: var(--error-color); cursor: wait; font-size: 1rem; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        .typing-indicator { display: none; align-self: flex-start; background: transparent; color: #888; font-size: 0.9rem; margin-left: 10px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>ğŸš€ ä½œæ–‡åŠ é€Ÿå™¨</h2>
        <p>ä¸€å‰‡æ•…äº‹çš„çœæ€</p>
        <input type="text" id="student-id" placeholder="è«‹è¼¸å…¥åº§è™Ÿ" inputmode="numeric">
        <button id="start-btn" onclick="startSession()">é–‹å§‹å¯«ä½œ</button>
    </div>

    <header id="header-title">ä¸€å‰‡æ•…äº‹çš„çœæ€</header>
    <div id="chat-container"></div>
    <div class="typing-indicator" id="loader">è€å¸«æ­£åœ¨æ€è€ƒ...</div>
    
    <div id="quick-actions">
        <button class="quick-btn" onclick="sendQuickReply('1')">é¸é … 1</button>
        <button class="quick-btn" onclick="sendQuickReply('2')">é¸é … 2</button>
        <button class="quick-btn" onclick="sendQuickReply('3')">é¸é … 3</button>
        <button class="quick-btn" onclick="sendQuickReply('è«‹çµ¦æˆ‘å»ºè­°')">ğŸ’¡ éˆæ„Ÿ</button>
    </div>

    <div id="input-area">
        <input type="text" id="user-input" placeholder="è¼¸å…¥æƒ³æ³•..." onkeypress="handleKeyPress(event)" autocomplete="off">
        <button id="send-btn" onclick="sendMessage()">â¤</button>
    </div>

<script>
    // ==========================================================
    //  ã€è¨­å®šå€ã€‘
    // ==========================================================
    
    // â˜…â˜…â˜… é€™è£¡ä¸€å®šè¦æ”¾æ›¿èº«ä»£ç¢¼ï¼ŒGitHub Action æ‰æœƒå¹«ä½ æ›æˆçœŸçš„ â˜…â˜…â˜…
    const GEMINI_API_KEY = "SECRET_KEY_PLACEHOLDER"; 

    const firebaseConfig = {
        apiKey: "AIzaSyDaYe4bu-RujGIfzjzKkrZgl1EPCxGYVN4",
        authDomain: "writing-ai-teacher.firebaseapp.com",
        projectId: "writing-ai-teacher",
        storageBucket: "writing-ai-teacher.firebasestorage.app",
        messagingSenderId: "108006740134",
        appId: "1:108006740134:web:a203bd35d14f345aa56467",
        measurementId: "G-TBVCG59B3M"
    };

    const SYSTEM_PROMPT = `
    ä½ æ˜¯ä¸€ä½åœ‹å°å…­å¹´ç´šåœ‹èªè€å¸«ã€‚ä»»å‹™æ˜¯ã€Œå¿«é€Ÿã€å¼•å°å­¸ç”Ÿå®Œæˆä½œæ–‡ã€ˆä¸€å‰‡æ•…äº‹çš„çœæ€ã€‰ã€‚
    ã€æ ¸å¿ƒè¦å‰‡ã€‘
    1. ç‚ºäº†ç¯€çœå­¸ç”Ÿæ‰“å­—æ™‚é–“ï¼Œ**æ¯å€‹æ­¥é©Ÿè«‹å‹™å¿…ä¸»å‹•æä¾› 3 å€‹å…·é«”çš„é¸é … (æ¨™ç¤º 1, 2, 3)**ã€‚
    2. å­¸ç”Ÿå¯ä»¥ç›´æ¥å›ç­”æ•¸å­— (å¦‚ "1")ã€‚
    3. èªæ°£è¦ªåˆ‡ï¼Œå¤šé¼“å‹µã€‚
    `;

    let db = null;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    } catch (e) { console.warn("Firebase Error", e); }

    let studentId = "";
    let chatHistory = []; 

    function startSession() {
        const input = document.getElementById('student-id').value.trim();
        if (!input) return alert("è«‹è¼¸å…¥åº§è™Ÿï¼");
        
        studentId = input;
        document.getElementById('header-title').innerText = `åº§è™Ÿ: ${studentId}`;
        document.getElementById('login-screen').style.display = 'none';

        chatHistory = [
            { role: "user", parts: [{ text: SYSTEM_PROMPT }] },
            { role: "model", parts: [{ text: "æ”¶åˆ°ï¼Œæˆ‘æœƒæä¾›é¸é …ã€‚" }] }
        ];

        const welcomeMsg = `å“ˆå›‰ï¼æˆ‘æ˜¯ä½œæ–‡å°è€å¸«ã€‚ç‚ºäº†è®“ä½ å¯«å¾—æ›´å¿«ï¼Œæˆ‘æœƒç›´æ¥çµ¦ä½ å»ºè­°ï¼Œä½ åªè¦é¸è™Ÿç¢¼å°±å¯ä»¥äº†ï¼ğŸ‘Œ\n\n**ç¬¬ä¸€æ­¥ï¼šè«‹é¸æ“‡ä½ æƒ³å¯«çš„æ•…äº‹ (é»æ“Šä¸‹æ–¹æŒ‰éˆ•æˆ–è¼¸å…¥æ•¸å­—)ï¼š**\n\n1. **é¾œå…”è³½è·‘** (é—œæ–¼å …æŒèˆ‡é©•å‚²)\n2. **æ”¾ç¾Šçš„å­©å­** (é—œæ–¼èª å¯¦)\n3. **äº•åº•ä¹‹è›™** (é—œæ–¼çœ¼ç•Œ)\n\n(å¦‚æœä½ æƒ³å¯«åˆ¥çš„ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‰“å­—å‘Šè¨´æˆ‘å–”ï¼)`;
        appendMessage("bot", welcomeMsg);
        chatHistory.push({ role: "model", parts: [{ text: welcomeMsg }] });
    }

    function sendQuickReply(text) {
        document.getElementById('user-input').value = text;
        sendMessage();
    }

    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const userText = inputField.value.trim();
        
        if (!userText) return;
        if (sendBtn.disabled) return;

        appendMessage("user", userText);
        inputField.value = "";
        saveToFirebase(userText, "user");

        chatHistory.push({ role: "user", parts: [{ text: userText }] });
        document.getElementById('loader').style.display = 'block';
        
        sendBtn.disabled = true;
        const quickBtns = document.querySelectorAll('.quick-btn');
        quickBtns.forEach(b => b.disabled = true);

        try {
            const botReply = await callGeminiAPI(chatHistory);
            appendMessage("bot", botReply);
            chatHistory.push({ role: "model", parts: [{ text: botReply }] });
            saveToFirebase(botReply, "model");

        } catch (error) {
            console.error(error);
            if (error.message.includes("429") || error.message.includes("å¿™ç¢Œ")) {
                startCoolDown(30); 
                appendMessage("bot", `ğŸš¦ **ç³»çµ±å¡è»Šä¸­** (å…è²»ç‰ˆé¡åº¦æ»¿äº†)\nè«‹çœ‹å³ä¸‹è§’æŒ‰éˆ•å€’æ•¸ï¼Œå€’æ•¸å®Œå†æŒ‰ä¸€æ¬¡å³å¯ï¼`);
            } else {
                appendMessage("bot", `âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`);
                sendBtn.disabled = false;
            }
        } finally {
            document.getElementById('loader').style.display = 'none';
            if (!document.getElementById('send-btn').classList.contains('cooling')) {
                sendBtn.disabled = false;
                quickBtns.forEach(b => b.disabled = false);
            }
            inputField.focus();
        }
    }

    function startCoolDown(seconds) {
        const btn = document.getElementById('send-btn');
        btn.classList.add('cooling'); 
        btn.disabled = true;
        
        let timeLeft = seconds;
        btn.innerText = timeLeft; 
        
        const timer = setInterval(() => {
            timeLeft--;
            btn.innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timer);
                btn.classList.remove('cooling');
                btn.innerText = "â¤";
                btn.disabled = false;
                const quickBtns = document.querySelectorAll('.quick-btn');
                quickBtns.forEach(b => b.disabled = false);
            }
        }, 1000);
    }

    async function callGeminiAPI(history) {
        const modelName = "gemini-1.5-flash"; 
        let url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`;
        
        const payload = {
            contents: history,
            generationConfig: { maxOutputTokens: 800, temperature: 0.7 }
        };

        let response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            if (response.status === 429) throw new Error("429 Busy");
            if (response.status === 404) {
                 return await callGeminiFallback(history);
            }
            throw new Error(response.statusText);
        }
        
        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
    }

    async function callGeminiFallback(history) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-latest:generateContent?key=${GEMINI_API_KEY}`;
        const response = await fetch(url, {
             method: 'POST',
             headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ contents: history })
        });
        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
    }

    function appendMessage(sender, text) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        try { div.innerHTML = marked.parse(text); } catch (e) { div.innerText = text; }
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function saveToFirebase(text, role) {
        if (!db) return;
        try {
            const docRef = db.collection("grade6_essays").doc(studentId);
            docRef.collection("chat").add({
                text: text, role: role, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            docRef.set({
                student_id: studentId, last_active: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        } catch (e) { console.warn("Save failed", e); }
    }

    function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }
</script>
</body>
</html>
