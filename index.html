<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½œæ–‡å°è€å¸«ï¼šä¸€å‰‡æ•…äº‹çš„çœæ€</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root { --primary-color: #4285f4; --bg-color: #f0f2f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        #login-screen input { font-size: 1.2rem; padding: 12px; margin: 10px; border: 2px solid #ddd; border-radius: 12px; width: 200px; text-align: center; outline: none; }
        #login-screen button { font-size: 1.2rem; padding: 12px 40px; background: var(--primary-color); color: white; border: none; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        #login-screen button:hover { background: #3367d6; transform: translateY(-2px); }

        header { background: white; padding: 15px; text-align: center; font-weight: bold; color: #444; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 10; font-size: 1.1rem; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; background: #f0f2f5; }
        
        .message { max-width: 85%; padding: 12px 18px; border-radius: 18px; line-height: 1.6; font-size: 1rem; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .bot { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 4px; }
        .user { align-self: flex-end; background: var(--primary-color); color: white; border-bottom-right-radius: 4px; }
        .system-msg { align-self: center; background: #fff3cd; color: #856404; font-size: 0.85rem; padding: 5px 15px; border-radius: 20px; margin: 5px 0; border: 1px solid #ffeeba; }
        
        #input-area { background: white; padding: 15px; display: flex; gap: 10px; border-top: 1px solid #ddd; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        #user-input { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 1rem; outline: none; background: #f8f9fa; }
        #send-btn { background: var(--primary-color); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #send-btn:disabled { background: #ccc; cursor: wait; }
        .typing-indicator { display: none; align-self: flex-start; background: transparent; color: #888; font-size: 0.9rem; margin-left: 10px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>âœï¸ ä½œæ–‡å°å¹«æ‰‹</h2>
        <p>åº·è»’å…­ä¸Šï¼šä¸€å‰‡æ•…äº‹çš„çœæ€</p>
        <input type="text" id="student-id" placeholder="è«‹è¼¸å…¥åº§è™Ÿ (ä¾‹å¦‚: 05)" inputmode="numeric">
        <button id="start-btn" onclick="startSession()">é–‹å§‹å¯«ä½œ</button>
        <p id="status-msg" style="color:red; font-size:0.9rem; display:none; margin-top:10px;"></p>
    </div>

    <header id="header-title">ä¸€å‰‡æ•…äº‹çš„çœæ€</header>
    <div id="chat-container"></div>
    <div class="typing-indicator" id="loader">è€å¸«æ­£åœ¨æ€è€ƒ...</div>
    
    <div id="input-area">
        <input type="text" id="user-input" placeholder="è¼¸å…¥ä½ çš„æƒ³æ³•..." onkeypress="handleKeyPress(event)" autocomplete="off">
        <button id="send-btn" onclick="sendMessage()">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
        </button>
    </div>

<script>
    // ==========================================================
    //  ã€è¨­å®šå€ã€‘
    // ==========================================================
    
    // è€å¸«ï¼Œæˆ‘å·²ç¶“å¹«æ‚¨æŠŠ Key å¡«å¥½äº†ï¼Œè«‹ä¸è¦ä¿®æ”¹é€™è£¡ï¼Œç›´æ¥ä½¿ç”¨å³å¯ï¼
    const GEMINI_API_KEY = "AIzaSyDRxDE-aXqLZhzhKyB546TULbyibcNPDpY"; 

    // Firebase è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyDaYe4bu-RujGIfzjzKkrZgl1EPCxGYVN4",
        authDomain: "writing-ai-teacher.firebaseapp.com",
        projectId: "writing-ai-teacher",
        storageBucket: "writing-ai-teacher.firebasestorage.app",
        messagingSenderId: "108006740134",
        appId: "1:108006740134:web:a203bd35d14f345aa56467",
        measurementId: "G-TBVCG59B3M"
    };

    // ==========================================================
    //  ç³»çµ±æ ¸å¿ƒ (ç©©å®šç‰ˆ)
    // ==========================================================

    const SYSTEM_PROMPT = `
    ä½ æ˜¯ä¸€ä½è¦ªåˆ‡ã€æœ‰è€å¿ƒçš„åœ‹å°å…­å¹´ç´šåœ‹èªè€å¸«ã€‚ä»»å‹™æ˜¯å¼•å°å­¸ç”Ÿå®Œæˆä½œæ–‡ã€ˆä¸€å‰‡æ•…äº‹çš„çœæ€ã€‰ã€‚
    1. çµ•å°ä¸å¯ç›´æ¥å¹«å­¸ç”Ÿå¯«æ–‡ç« ï¼Œåªèƒ½ç”¨æå•å¼•å°ã€‚
    2. èªæ°£è¦è¦ªåˆ‡ï¼Œå¤šçµ¦äºˆæ­£å‘é¼“å‹µã€‚
    3. æ¯æ¬¡åªå•ä¸€å€‹æ­¥é©Ÿï¼Œç­‰å¾…å­¸ç”Ÿå›ç­”ã€‚
    
    ã€å¼•å°æ­¥é©Ÿã€‘
    1. [cite_start]é¸å®šæ•…äº‹ï¼šè«‹å­¸ç”Ÿé¸ä¸€å€‹æ•…äº‹ï¼ˆä¾‹å¦‚åº·è»’èª²æœ¬æéçš„ã€ä¸‰äººæˆè™ã€ï¼Œæˆ–æ˜¯å¯“è¨€æ•…äº‹å¦‚é¾œå…”è³½è·‘ã€äº•åº•ä¹‹è›™ï¼‰ã€‚[cite: 3, 4, 31]
    2. [cite_start]å–æèˆ‡æ§‹æ€ï¼šè«‹å­¸ç”Ÿç°¡å–®èªªå‡ºæ•…äº‹å¤§æ„ï¼ˆä¸»è§’æ˜¯èª°ï¼Ÿç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿï¼‰ã€‚[cite: 9]
    3. [cite_start]ç¢ºç«‹ä¸»æ—¨ï¼šå•å­¸ç”Ÿé€™å€‹æ•…äº‹æƒ³å‘Šè¨´æˆ‘å€‘ä»€éº¼é“ç†ï¼Ÿ[cite: 8, 12]
    4. [cite_start]ç”Ÿæ´»çœæ€ï¼šå¼•å°å­¸ç”Ÿæ€è€ƒï¼Œé€™å€‹é“ç†åœ¨ç”Ÿæ´»ä¸­æœ‰æ²’æœ‰é¡ä¼¼çš„ç¶“é©—ï¼Ÿ[cite: 14, 15]
    5. [cite_start]æ“¬å®šå¤§ç¶±ï¼šæ•´ç†æˆå¯«ä½œå¤§ç¶±ï¼ˆç·£èµ· -> æ•…äº‹ç°¡è¿° -> çœæ€ -> çµèªï¼‰ã€‚[cite: 17-24]
    `;

    // åˆå§‹åŒ– Firebase
    let db = null;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase åˆå§‹åŒ–æˆåŠŸ");
    } catch (e) {
        console.warn("Firebase é€£ç·šå¤±æ•—:", e);
    }

    let studentId = "";
    let chatHistory = []; 

    // å•Ÿå‹•å°è©±
    function startSession() {
        const input = document.getElementById('student-id').value.trim();
        if (!input) return alert("è«‹è¼¸å…¥åº§è™Ÿï¼");
        
        studentId = input;
        document.getElementById('header-title').innerText = `åº§è™Ÿ: ${studentId} çš„ä½œæ–‡æŒ‡å°`;
        document.getElementById('login-screen').style.display = 'none';

        chatHistory = [
            { role: "user", parts: [{ text: SYSTEM_PROMPT }] },
            { role: "model", parts: [{ text: "æ”¶åˆ°ï¼Œæˆ‘æ˜¯ä½œæ–‡è€å¸«ã€‚" }] }
        ];

        const welcomeMsg = `å“ˆå›‰ï¼æˆ‘æ˜¯ä½œæ–‡å°è€å¸«ã€‚åº§è™Ÿ ${studentId} çš„åŒå­¸ä½ å¥½ï¼ğŸ‘‹\n\næˆ‘å€‘ä»Šå¤©è¦ç·´ç¿’å¯«ã€ˆä¸€å‰‡æ•…äº‹çš„çœæ€ã€‰ã€‚å¯«ä½œçš„ç¬¬ä¸€æ­¥æ˜¯é¸æ•…äº‹ã€‚\n\n**ä½ æƒ³å¥½è¦å¯«å“ªä¸€å€‹æ•…äº‹äº†å—ï¼Ÿ**\n(ä¾‹å¦‚ï¼šä¸‰äººæˆè™ã€é¾œå…”è³½è·‘ï¼Œæˆ–æ˜¯ä½ è‡ªå·±çœ‹éçš„æ›¸éƒ½å¯ä»¥å–”ï¼)`;
        appendMessage("bot", welcomeMsg);
        chatHistory.push({ role: "model", parts: [{ text: welcomeMsg }] });
    }

    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const userText = inputField.value.trim();
        if (!userText) return;

        appendMessage("user", userText);
        inputField.value = "";
        saveToFirebase(userText, "user");

        chatHistory.push({ role: "user", parts: [{ text: userText }] });
        document.getElementById('loader').style.display = 'block';
        document.getElementById('send-btn').disabled = true;

        try {
            const botReply = await callGeminiAPI(chatHistory, 0);
            
            appendMessage("bot", botReply);
            chatHistory.push({ role: "model", parts: [{ text: botReply }] });
            saveToFirebase(botReply, "model");

        } catch (error) {
            console.error(error);
            appendMessage("bot", `âš ï¸ è€å¸«ç¾åœ¨æœ‰é»å¿™ï¼Œè«‹ç¨ç­‰ä¸€ä¸‹å†é‡æ–°ç™¼é€è©¦è©¦çœ‹ï¼\n(${error.message})`);
        } finally {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('send-btn').disabled = false;
            inputField.focus();
        }
    }

    // å‘¼å« Gemini API
    async function callGeminiAPI(history, retryCount) {
        
        // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šä½¿ç”¨ "gemini-flash-latest" â˜…â˜…â˜…
        // é€™å€‹ä»£è™Ÿåœ¨æ‚¨çš„ç™½åå–®ä¸­ï¼Œè€Œä¸”æ˜¯æŒ‡å‘æœ€ç©©å®šçš„ç‰ˆæœ¬
        const modelName = "gemini-flash-latest"; 
        
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`;
        
        const payload = {
            contents: history,
            generationConfig: { maxOutputTokens: 800, temperature: 0.7 }
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // è™•ç† 429 å¡è»Š (è‡ªå‹•é‡è©¦)
            if (response.status === 429) {
                if (retryCount < 3) {
                    const waitTime = (retryCount + 1) * 2000; 
                    console.warn(`[429] ç³»çµ±å¿™ç¢Œï¼Œä¼‘æ¯ ${waitTime/1000} ç§’å¾Œé‡è©¦...`);
                    showSystemMessage(`â³ ç³»çµ±å¿™ç¢Œæ’éšŠä¸­ï¼Œè«‹ç¨å€™... (ç¬¬ ${retryCount+1} æ¬¡å˜—è©¦)`);
                    
                    await new Promise(r => setTimeout(r, waitTime));
                    return await callGeminiAPI(history, retryCount + 1);
                } else {
                    throw new Error("ç›®å‰ä½¿ç”¨äººæ•¸éå¤šï¼Œè«‹ä¼‘æ¯ 30 ç§’å¾Œå†è©¦ä¸€æ¬¡ï¼");
                }
            }

            const data = await response.json();
            
            if (!response.ok) {
                // å¦‚æœé€£é€™å€‹éƒ½æ‰¾ä¸åˆ°ï¼Œæˆ‘å€‘æœ€å¾Œè©¦è©¦ Pro-latest
                if (response.status === 404) {
                    return await callGeminiFallback(history);
                }
                throw new Error(data.error?.message || response.statusText);
            }
            
            return data.candidates[0].content.parts[0].text;

        } catch (e) {
            throw e;
        }
    }

    // å‚™ç”¨æ–¹æ¡ˆ
    async function callGeminiFallback(history) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-latest:generateContent?key=${GEMINI_API_KEY}`;
        const response = await fetch(url, {
             method: 'POST',
             headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ contents: history })
        });
        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
    }

    function appendMessage(sender, text) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        try { div.innerHTML = marked.parse(text); } catch (e) { div.innerText = text; }
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function showSystemMessage(text) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `system-msg`;
        div.innerText = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function saveToFirebase(text, role) {
        if (!db) return;
        try {
            const docRef = db.collection("grade6_essays").doc(studentId);
            docRef.collection("chat").add({
                text: text, role: role, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            docRef.set({
                student_id: studentId, last_active: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        } catch (e) { console.warn("Save failed", e); }
    }

    function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }
</script>
</body>
</html>
