<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸ« ä½œæ–‡èª² - è€å¸«ç›£æ§çœ‹æ¿</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #4285f4; --bg: #f8f9fa; --card-bg: #ffffff; --danger: #ff4d4f; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        h1 { text-align: center; color: #444; margin-bottom: 20px; }
        .container { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        
        /* å­¸ç”Ÿå¡ç‰‡ */
        .student-card { position: relative; background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ddd; cursor: pointer; transition: 0.2s; }
        .student-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .student-card.active { border-left-color: #34a853; } /* ä¸Šç·šä¸­è®Šç¶ è‰² */
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-right: 25px; }
        .student-id { font-size: 1.2rem; font-weight: bold; color: #333; }
        .status { font-size: 0.85rem; color: #888; background: #eee; padding: 2px 8px; border-radius: 10px; }
        .status.live { background: #e6f4ea; color: #137333; }
        
        .last-msg { font-size: 0.9rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; }
        .time { font-size: 0.8rem; color: #aaa; text-align: right; }

        /* åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
        .delete-btn {
            position: absolute; top: 10px; right: 10px;
            width: 24px; height: 24px; border-radius: 50%;
            background: #fff; border: 1px solid #ddd; color: #999;
            font-size: 18px; line-height: 22px; text-align: center;
            cursor: pointer; z-index: 10; transition: 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .delete-btn:hover { background: var(--danger); color: white; border-color: var(--danger); }

        /* å½ˆå‡ºè¦–çª— */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #modal { background: white; width: 90%; max-width: 600px; height: 80vh; border-radius: 15px; display: flex; flex-direction: column; overflow: hidden; }
        #modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; }
        #modal-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; background: #fff; }
        #close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }

        /* å°è©±æ°£æ³¡ */
        .msg-row { display: flex; flex-direction: column; max-width: 85%; }
        .msg-row.user { align-self: flex-end; align-items: flex-end; }
        .msg-row.model { align-self: flex-start; align-items: flex-start; }
        .bubble { padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; }
        .user .bubble { background: #4285f4; color: white; border-bottom-right-radius: 2px; }
        .model .bubble { background: #f1f3f4; color: #333; border-bottom-left-radius: 2px; }
        .msg-time { font-size: 0.75rem; color: #ccc; margin-top: 3px; }
    </style>
</head>
<body>

    <h1>ğŸ‘¨â€ğŸ« ä½œæ–‡èª²å³æ™‚ç›£æ§ (å…± <span id="count">0</span> äºº)</h1>
    <div id="loading" style="text-align:center; color:#888;">æ­£åœ¨é€£ç·šåˆ°æ•™å®¤...</div>
    <div class="container" id="card-container"></div>

    <div id="modal-overlay" onclick="closeModal(event)">
        <div id="modal">
            <div id="modal-header">
                <h3 id="modal-title">åº§è™Ÿ 00 çš„å°è©±ç´€éŒ„</h3>
                <button id="close-btn" onclick="closeModal(event)">Ã—</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

<script>
    // ==========================================
    //  Firebase è¨­å®š
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDaYe4bu-RujGIfzjzKkrZgl1EPCxGYVN4",
        authDomain: "writing-ai-teacher.firebaseapp.com",
        projectId: "writing-ai-teacher",
        storageBucket: "writing-ai-teacher.firebasestorage.app",
        messagingSenderId: "108006740134",
        appId: "1:108006740134:web:a203bd35d14f345aa56467",
        measurementId: "G-TBVCG59B3M"
    };

    try {
        firebase.initializeApp(firebaseConfig);
    } catch(e) { console.error(e); }
    const db = firebase.firestore();

    const container = document.getElementById('card-container');
    const countSpan = document.getElementById('count');
    const loading = document.getElementById('loading');

    // å³æ™‚ç›£è½å­¸ç”Ÿåˆ—è¡¨
    db.collection("grade6_essays").orderBy("last_active", "desc").onSnapshot((snapshot) => {
        loading.style.display = 'none';
        container.innerHTML = "";
        countSpan.innerText = snapshot.size;

        if (snapshot.empty) {
            container.innerHTML = "<p style='text-align:center; width:100%; color:#999;'>ç›®å‰é‚„æ²’æœ‰å­¸ç”Ÿç™»å…¥å–”ï¼</p>";
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const studentId = doc.id;
            
            // è¨ˆç®—ç‹€æ…‹
            let timeStr = "å‰›å‰›";
            let isOnline = false;
            if (data.last_active) {
                const date = data.last_active.toDate();
                timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const diff = (new Date() - date) / 1000 / 60; 
                if (diff < 5) isOnline = true;
            }

            // å»ºç«‹å¡ç‰‡
            const card = document.createElement('div');
            card.className = `student-card ${isOnline ? 'active' : ''}`;
            
            // é»æ“Šå¡ç‰‡æœ¬é«” -> æ‰“é–‹å°è©±
            card.onclick = () => openStudentChat(studentId);

            card.innerHTML = `
                <div class="delete-btn" onclick="deleteStudent('${studentId}', event)" title="åˆªé™¤æ­¤å­¸ç”Ÿç´€éŒ„">Ã—</div>
                
                <div class="card-header">
                    <div class="student-id">åº§è™Ÿ ${studentId}</div>
                    <div class="status ${isOnline ? 'live' : ''}">${isOnline ? 'â— ä¸Šç·šä¸­' : 'é›¢ç·š'}</div>
                </div>
                <div class="last-msg">æœ€æ–°å…§å®¹... (é»æ“ŠæŸ¥çœ‹)</div>
                <div class="time">æœ€å¾Œæ›´æ–°: ${timeStr}</div>
            `;
            container.appendChild(card);
        });
    });

    // åˆªé™¤åŠŸèƒ½
    function deleteStudent(studentId, event) {
        event.stopPropagation(); // é¿å…è§¸ç™¼æ‰“é–‹å°è©±è¦–çª—
        
        if (confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤ã€Œåº§è™Ÿ ${studentId}ã€çš„æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ\n(é€™é …æ“ä½œç„¡æ³•å¾©åŸå–”ï¼)`)) {
            db.collection("grade6_essays").doc(studentId).delete()
            .then(() => {
                // åˆªé™¤æˆåŠŸï¼Œä»‹é¢æœƒè‡ªå‹•æ›´æ–° (å› ç‚ºæœ‰ onSnapshot)
                console.log("åˆªé™¤æˆåŠŸ");
            })
            .catch((error) => {
                alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
                console.error("Error removing document: ", error);
            });
        }
    }

    // æ‰“é–‹è©³ç´°å°è©±
    let currentUnsubscribe = null;

    function openStudentChat(studentId) {
        const modal = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        modal.style.display = 'flex';
        modalTitle.innerText = `åº§è™Ÿ ${studentId} çš„å¯«ä½œæ­·ç¨‹`;
        modalBody.innerHTML = "<p style='text-align:center; color:#999;'>è¼‰å…¥å°è©±ä¸­...</p>";

        if (currentUnsubscribe) currentUnsubscribe();

        currentUnsubscribe = db.collection("grade6_essays").doc(studentId)
            .collection("chat").orderBy("timestamp", "asc")
            .onSnapshot(snapshot => {
                modalBody.innerHTML = "";
                if (snapshot.empty) {
                    modalBody.innerHTML = "<p style='text-align:center; color:#999;'>ç›®å‰æ²’æœ‰å°è©±ç´€éŒ„ã€‚</p>";
                    return;
                }

                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const div = document.createElement('div');
                    div.className = `msg-row ${msg.role === 'model' ? 'model' : 'user'}`;
                    
                    let time = "";
                    if (msg.timestamp) {
                        time = msg.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }

                    div.innerHTML = `
                        <div class="bubble">${msg.text}</div>
                        <div class="msg-time">${time}</div>
                    `;
                    modalBody.appendChild(div);
                });
                modalBody.scrollTop = modalBody.scrollHeight;
            });
    }

    function closeModal(e) {
        if (e.target.id === 'modal-overlay' || e.target.id === 'close-btn') {
            document.getElementById('modal-overlay').style.display = 'none';
            if (currentUnsubscribe) currentUnsubscribe();
        }
    }
</script>

</body>
</html>